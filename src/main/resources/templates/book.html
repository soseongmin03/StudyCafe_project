<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <meta charset="UTF-8">
    <title>ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <style>
        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background-color: #fff; }

        /* [ìˆ˜ì •] ë„¤ë¹„ê²Œì´ì…˜ ì˜ì—­ ë¹„ìœ¨ ì¡°ì • */
        .nav-area { display: flex; align-items: center; gap: 10px; }
        .nav-area.left { flex: 1; justify-content: flex-start; }
        .nav-area.right { flex: 1; justify-content: flex-end; } /* ì˜¤ë¥¸ìª½ ë ì •ë ¬ */

        .main-title { flex: 2; text-align: center; font-size: 1.8rem; margin: 0; }

        .nav-btn, .cancel-btn, .charge-btn {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white;
        }
        .nav-btn { background-color: #34495e; }
        .cancel-btn { background-color: #e67e22; }
        .charge-btn { background-color: #9b59b6; }

        .seat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 20px; }
        .seat-card { width: 120px; height: 120px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: white; border: 2px solid #333; }
        .available { background-color: #2ecc71; }
        .occupied { background-color: #e74c3c; }
        .time-text { font-size: 0.85em; color: #f1c40f; margin-bottom: 2px; }
        .error-msg { color: red; font-weight: bold; text-align: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px; }
        .modal-box select { padding: 8px; font-size: 16px; margin: 15px 0; width: 100%; }
    </style>
</head>
<body>

<div class="header-container">
    <div class="nav-area left">
        <form th:action="@{/home}" method="get">
            <button type="submit" class="nav-btn">í™ˆìœ¼ë¡œ</button>
        </form>
        <button type="button" onclick="openChargeModal()" class="charge-btn">âš¡ ì‹œê°„ ì¶©ì „</button>
    </div>

    <div style="text-align: center; flex: 2;">
        <h1 class="main-title">ìŠ¤í„°ë””ì¹´í˜ ì¢Œì„ í˜„í™©</h1>
        <div style="color: #2980b9; font-weight: bold; margin-top: 5px;">
            â³ ë‚´ ì´ ì”ì—¬ ì‹œê°„: <span th:text="${remainingMinutes}">0</span>ë¶„
        </div>
    </div>

    <div class="nav-area right">
        <form th:action="@{/book/cancel}" method="post">
            <button type="submit" class="cancel-btn">í‡´ì‹¤í•˜ê¸° (ì”ì—¬ì‹œê°„ í™˜ë¶ˆ)</button>
        </form>
    </div>
</div>

<div class="error-msg">
    <div th:if="${param.alreadyRegistered}">âš ï¸ ì´ë¯¸ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ì‹œê°„ ì¶©ì „ì„ í•˜ì‹œê±°ë‚˜ í‡´ì‹¤ í›„ ì´ë™í•´ì£¼ì„¸ìš”.</div>
    <div th:if="${param.noBooking}">âš ï¸ ì´ìš© ì¤‘ì¸ ì¢Œì„ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    <div th:if="${param.error}" th:text="${param.error}"></div>
</div>
<hr>

<div class="seat-grid">
    <div th:each="seat : ${seats}" th:classappend="${seat.isFull} ? 'occupied' : 'available'" class="seat-card">
        <div th:text="${seat.seatNumber} + 'ë²ˆ ì¢Œì„'"></div>

        <div th:if="${!seat.isFull}" style="margin-top: 5px;">
            <button type="button" th:onclick="'attemptReserve(' + ${seat.id} + ')'"
                    style="cursor:pointer; border:1px solid white; background:transparent; color:white; padding:5px 10px; border-radius:4px;">
                ì˜ˆì•½í•˜ê¸°
            </button>
        </div>

        <div th:if="${seat.isFull}" style="font-size: 0.8em; margin-top: 5px; text-align: center;">
            <div class="time-text" th:text="${seat.remainingTimeStr} + ' ë‚¨ìŒ'"></div>
            <span th:text="${seat.reservedByName}"></span>ë‹˜
        </div>
    </div>
</div>

<div id="reserveModal" class="modal-overlay">
    <div class="modal-box">
        <h3>ğŸ’³ ì‹œê°„ ë¶€ì¡± - ì¶©ì „ ë° ì˜ˆì•½</h3>
        <p>ì”ì—¬ ì‹œê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.<br>ì‹œê°„ì„ êµ¬ë§¤í•˜ë©´ ë°”ë¡œ ì˜ˆì•½ë©ë‹ˆë‹¤.</p>

        <form id="reserveForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="seatId" id="modalSeatId">
            <input type="hidden" name="useAll" value="false">

            <select name="duration" id="durationSelect">
                <option value="1">1ì‹œê°„ (1,000ì›)</option>
                <option value="2">2ì‹œê°„ (2,000ì›)</option>
                <option value="4">4ì‹œê°„ (4,000ì›)</option>
                <option value="6">6ì‹œê°„ (6,000ì›)</option>
                <option value="12">12ì‹œê°„ (12,000ì›)</option>
            </select>

            <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button type="button" onclick="closeModal('reserveModal')" class="nav-btn" style="background:#95a5a6; width:45%;">ì·¨ì†Œ</button>
                <button type="button" onclick="requestPayAndReserve()" class="nav-btn" style="background:#3498db; width:45%;">ê²°ì œ ë° ì˜ˆì•½</button>
            </div>
        </form>
    </div>
</div>

<form id="quickReserveForm" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="useAll" value="true">
</form>

<div id="chargeModal" class="modal-overlay">
    <div class="modal-box">
        <h3>âš¡ ì‹œê°„ ì¶©ì „</h3>
        <p>ì¶©ì „ ì‹œ ì´ìš© ì¤‘ì¸ ì¢Œì„ ì‹œê°„ì´<br>ìë™ìœ¼ë¡œ ì—°ì¥ë©ë‹ˆë‹¤.</p>
        <select id="chargeDuration">
            <option value="1">1ì‹œê°„ (1,000ì›)</option>
            <option value="2">2ì‹œê°„ (2,000ì›)</option>
            <option value="4">4ì‹œê°„ (4,000ì›)</option>
            <option value="6">6ì‹œê°„ (6,000ì›)</option>
            <option value="12">12ì‹œê°„ (12,000ì›)</option>
        </select>
        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
            <button type="button" onclick="closeModal('chargeModal')" class="nav-btn" style="background:#95a5a6; width:45%;">ì·¨ì†Œ</button>
            <button type="button" onclick="requestCharge()" class="nav-btn" style="background:#9b59b6; width:45%;">ê²°ì œí•˜ê¸°</button>
        </div>
    </div>
</div>

<form id="chargeForm" method="post" action="/book/charge" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="duration" id="formChargeDuration">
</form>

<script th:inline="javascript">
    var IMP = window.IMP;
    IMP.init("imp85083064");

    // ì„œë²„ì—ì„œ ë°›ì€ ì´ ì”ì—¬ ì‹œê°„
    var userRemainingMinutes = [[${remainingMinutes}]];

    // [í•µì‹¬ ë¡œì§] ì˜ˆì•½ ì‹œë„
    function attemptReserve(seatId) {
        if (userRemainingMinutes > 0) {
            // 1. ì‹œê°„ì´ ìˆìœ¼ë©´: ëª¨ë‹¬ ì—†ì´ ì¦‰ì‹œ ì˜ˆì•½ (ë³´ìœ  ì‹œê°„ ì „ì²´ ì‚¬ìš©)
            if(confirm("ë³´ìœ í•œ ì‹œê°„(" + userRemainingMinutes + "ë¶„)ìœ¼ë¡œ ë°”ë¡œ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                var form = document.getElementById('quickReserveForm');
                form.action = '/book/' + seatId;
                form.submit();
            }
        } else {
            // 2. ì‹œê°„ì´ ì—†ìœ¼ë©´: ê²°ì œ ëª¨ë‹¬ ë„ì›€
            document.getElementById('reserveModal').style.display = 'flex';
            document.getElementById('modalSeatId').value = seatId;
        }
    }

    // ì‹œê°„ ì¶©ì „ ëª¨ë‹¬
    function openChargeModal() {
        document.getElementById('chargeModal').style.display = 'flex';
    }

    // ì‹œê°„ ì¶©ì „ ê²°ì œ ìš”ì²­
    function requestCharge() {
        var duration = document.getElementById('chargeDuration').value;
        var price = duration * 1000;

        IMP.request_pay({
            pg: "kakaopay",
            pay_method: "card",
            merchant_uid: "CHG" + new Date().getTime(),
            name: "ì‹œê°„ ì¶©ì „ " + duration + "ì‹œê°„",
            amount: price,
            buyer_email: "test@test.com",
            buyer_name: "ì‚¬ìš©ì"
        }, function (rsp) {
            if (rsp.success) {
                alert("ì¶©ì „ ì„±ê³µ! (ì´ìš© ì¤‘ì¸ ì¢Œì„ì´ ìˆë‹¤ë©´ ìë™ ì—°ì¥ë©ë‹ˆë‹¤)");
                document.getElementById('formChargeDuration').value = duration;
                document.getElementById('chargeForm').submit();
            } else {
                alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
            }
        });
    }

    // ì˜ˆì•½ ëª¨ë‹¬ì—ì„œ ê²°ì œ ìš”ì²­
    function requestPayAndReserve() {
        var seatId = document.getElementById('modalSeatId').value;
        var duration = document.getElementById('durationSelect').value;
        var price = duration * 1000;

        IMP.request_pay({
            pg: "kakaopay",
            pay_method: "card",
            merchant_uid: "RES" + new Date().getTime(),
            name: duration + "ì‹œê°„ ì´ìš©ê¶Œ",
            amount: price,
            buyer_email: "test@test.com",
            buyer_name: "ì‚¬ìš©ì"
        }, function (rsp) {
            if (rsp.success) {
                alert("ê²°ì œ ì„±ê³µ! ì˜ˆì•½ì„ í™•ì •í•©ë‹ˆë‹¤.");
                var form = document.getElementById('reserveForm');
                form.action = '/book/' + seatId;
                form.submit();
            } else {
                alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
            }
        });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
</script>

</body>
</html>