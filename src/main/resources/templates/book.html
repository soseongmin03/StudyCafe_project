<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <meta charset="UTF-8">
    <title>ì¢Œì„ ì˜ˆì•½ | StudyCafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* [ì „ì²´ ì´ˆê¸°í™”] */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; }

        /* [ë„¤ë¹„ê²Œì´ì…˜ ë°”] home.htmlê³¼ í†µì¼ */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 40px; background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 1000;
        }
        .navbar .logo { font-size: 1.5rem; font-weight: 700; color: #2c3e50; text-decoration: none; }

        .nav-actions { display: flex; gap: 15px; align-items: center; }

        /* [ë²„íŠ¼ ìŠ¤íƒ€ì¼] ëª¨ë˜í•œ ê·¸ë¼ë””ì–¸íŠ¸ ë° ì‰ë„ìš° */
        .btn {
            padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        .btn-home { background-color: #ecf0f1; color: #2c3e50; text-decoration: none; }
        .btn-home:hover { background-color: #bdc3c7; }

        .btn-charge {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
        }
        .btn-charge:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(155, 89, 182, 0.4); }

        .btn-exit {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white;
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.3);
        }
        .btn-exit:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(230, 126, 34, 0.4); }

        /* [ë©”ì¸ ì»¨í…ì¸  ì˜ì—­] */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }

        .info-bar {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px;
            text-align: center; display: flex; flex-direction: column; gap: 10px;
        }
        .page-title { font-size: 1.8rem; font-weight: 700; color: #2c3e50; }
        .time-info { font-size: 1.2rem; color: #3498db; font-weight: 600; }
        .time-highlight { font-weight: 800; color: #2980b9; font-size: 1.4rem; }

        /* [ì—ëŸ¬ ë©”ì‹œì§€] */
        .error-msg {
            background-color: #ffeaea; color: #e74c3c; padding: 15px;
            border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 500;
            border: 1px solid #ffcccc;
        }

        /* [ì¢Œì„ ê·¸ë¦¬ë“œ] */
        .seat-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
            gap: 25px; padding: 10px;
        }

        /* [ì¢Œì„ ì¹´ë“œ] ë””ìì¸ ê°œì„  */
        .seat-card {
            background: white; height: 140px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; position: relative; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px solid transparent;
            overflow: hidden;
        }

        /* [ìƒíƒœ: ì´ìš© ê°€ëŠ¥] */
        .seat-card.available { border-color: #ecf0f1; color: #2c3e50; }
        .seat-card.available:hover {
            border-color: #3498db; transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.2);
        }
        .seat-card.available .seat-num { font-size: 1.2rem; margin-bottom: 10px; }

        .btn-reserve {
            background-color: #3498db; color: white; border: none; padding: 8px 16px;
            border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .btn-reserve:hover { background-color: #2980b9; }

        /* [ìƒíƒœ: ì´ìš© ì¤‘] */
        .seat-card.occupied {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white; border: none;
        }
        .seat-card.occupied .seat-num { font-size: 1.1rem; opacity: 0.8; margin-bottom: 5px; }
        .seat-card.occupied .user-name { font-size: 1rem; margin-bottom: 5px; }
        .seat-card.occupied .time-left { font-size: 0.85rem; color: #f1c40f; font-weight: 500; }

        /* [ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼] */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box {
            background: white; padding: 40px; border-radius: 15px; text-align: center; width: 350px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-box h3 { margin-bottom: 15px; color: #2c3e50; }
        .modal-box p { color: #7f8c8d; margin-bottom: 25px; font-size: 0.95rem; }
        .modal-box select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 1rem; margin-bottom: 25px; outline: none;
        }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background-color: #ecf0f1; color: #7f8c8d; }
        .btn-confirm { background-color: #3498db; color: white; }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a th:href="@{/home}" class="logo">ğŸ“– StudyCafe</a>

    <div class="nav-actions">
        <form th:action="@{/home}" method="get">
            <button type="submit" class="btn btn-home">ğŸ  í™ˆìœ¼ë¡œ</button>
        </form>
        <button type="button" onclick="openChargeModal()" class="btn btn-charge">âš¡ ì‹œê°„ ì¶©ì „</button>
        <form th:action="@{/book/cancel}" method="post">
            <button type="submit" class="btn btn-exit">ğŸšª í‡´ì‹¤í•˜ê¸°</button>
        </form>
    </div>
</nav>

<div class="container">
    <div class="info-bar">
        <h1 class="page-title">ì‹¤ì‹œê°„ ì¢Œì„ í˜„í™©</h1>
        <div class="time-info">
            â³ ë‚´ ì´ ì”ì—¬ ì‹œê°„: <span class="time-highlight" th:text="${remainingMinutes}">0</span>ë¶„
        </div>
    </div>

    <div class="error-msg" th:if="${param.alreadyRegistered}">
        âš ï¸ ì´ë¯¸ ì´ìš© ì¤‘ì¸ ì¢Œì„ì´ ìˆìŠµë‹ˆë‹¤. í‡´ì‹¤ í›„ ì´ë™í•´ì£¼ì„¸ìš”.
    </div>
    <div class="error-msg" th:if="${param.noBooking}">
        âš ï¸ í˜„ì¬ ì´ìš© ì¤‘ì¸ ì¢Œì„ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
    <div class="error-msg" th:if="${param.error}" th:text="${param.error}"></div>

    <div class="seat-grid">
        <div th:each="seat : ${seats}"
             th:classappend="${seat.isFull} ? 'occupied' : 'available'"
             class="seat-card">

            <div th:if="${!seat.isFull}" style="text-align:center; width:100%;">
                <div class="seat-num" th:text="${seat.seatNumber} + 'ë²ˆ'"></div>
                <button type="button" class="btn-reserve"
                        th:onclick="'attemptReserve(' + ${seat.id} + ')'">ì˜ˆì•½í•˜ê¸°</button>
            </div>

            <div th:if="${seat.isFull}" style="text-align:center; width:100%;">
                <div class="seat-num" th:text="${seat.seatNumber} + 'ë²ˆ'"></div>
                <div class="user-name"><span th:text="${seat.reservedByName}"></span>ë‹˜</div>
                <div class="time-left" th:text="${seat.remainingTimeStr} + ' ë‚¨ìŒ'"></div>
            </div>
        </div>
    </div>
</div>

<div id="reserveModal" class="modal-overlay">
    <div class="modal-box">
        <h3>ğŸ’³ ì‹œê°„ ì¶©ì „ ë° ì˜ˆì•½</h3>
        <p>ë³´ìœ  ì‹œê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.<br>ì‹œê°„ì„ ì¶©ì „í•˜ì‹œë©´ ë°”ë¡œ ì˜ˆì•½ë©ë‹ˆë‹¤.</p>

        <form id="reserveForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="seatId" id="modalSeatId">
            <input type="hidden" name="useAll" value="false">

            <select name="duration" id="durationSelect">
                <option value="1">1ì‹œê°„ (1,000ì›)</option>
                <option value="2">2ì‹œê°„ (2,000ì›)</option>
                <option value="4">4ì‹œê°„ (4,000ì›)</option>
                <option value="6">6ì‹œê°„ (6,000ì›)</option>
                <option value="12">12ì‹œê°„ (12,000ì›)</option>
            </select>

            <div class="modal-btns">
                <button type="button" onclick="closeModal('reserveModal')" class="modal-btn btn-cancel">ì·¨ì†Œ</button>
                <button type="button" onclick="requestPayAndReserve()" class="modal-btn btn-confirm">ê²°ì œí•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<form id="quickReserveForm" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="useAll" value="true">
</form>

<div id="chargeModal" class="modal-overlay">
    <div class="modal-box">
        <h3>âš¡ ì‹œê°„ ì¶©ì „</h3>
        <p>ì¶©ì „í•˜ì‹  ì‹œê°„ì€ ì˜êµ¬ì ìœ¼ë¡œ ë³´ê´€ë˜ë©°,<br>ì–¸ì œë“  ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        <select id="chargeDuration">
            <option value="1">1ì‹œê°„ (1,000ì›)</option>
            <option value="2">2ì‹œê°„ (2,000ì›)</option>
            <option value="4">4ì‹œê°„ (4,000ì›)</option>
            <option value="6">6ì‹œê°„ (6,000ì›)</option>
            <option value="12">12ì‹œê°„ (12,000ì›)</option>
        </select>
        <div class="modal-btns">
            <button type="button" onclick="closeModal('chargeModal')" class="modal-btn btn-cancel">ì·¨ì†Œ</button>
            <button type="button" onclick="requestCharge()" class="modal-btn btn-confirm" style="background-color: #9b59b6;">ì¶©ì „í•˜ê¸°</button>
        </div>
    </div>
</div>

<form id="chargeForm" method="post" action="/book/charge" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="duration" id="formChargeDuration">
</form>

<script th:inline="javascript">
    var IMP = window.IMP;
    IMP.init("imp85083064");

    // ì„œë²„ì—ì„œ ë°›ì€ ì´ ì”ì—¬ ì‹œê°„
    var userRemainingMinutes = [[${remainingMinutes}]];

    // [í•µì‹¬ ë¡œì§] ì˜ˆì•½ ì‹œë„
    function attemptReserve(seatId) {
        if (userRemainingMinutes > 0) {
            // 1. ì‹œê°„ì´ ìˆìœ¼ë©´: ëª¨ë‹¬ ì—†ì´ ì¦‰ì‹œ ì˜ˆì•½ (ë³´ìœ  ì‹œê°„ ì „ì²´ ì‚¬ìš©)
            if(confirm("ë³´ìœ í•œ ì‹œê°„(" + userRemainingMinutes + "ë¶„)ìœ¼ë¡œ ë°”ë¡œ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                var form = document.getElementById('quickReserveForm');
                form.action = '/book/' + seatId;
                form.submit();
            }
        } else {
            // 2. ì‹œê°„ì´ ì—†ìœ¼ë©´: ê²°ì œ ëª¨ë‹¬ ë„ì›€
            document.getElementById('reserveModal').style.display = 'flex';
            document.getElementById('modalSeatId').value = seatId;
        }
    }

    // ì‹œê°„ ì¶©ì „ ëª¨ë‹¬
    function openChargeModal() {
        document.getElementById('chargeModal').style.display = 'flex';
    }

    // ì‹œê°„ ì¶©ì „ ê²°ì œ ìš”ì²­
    function requestCharge() {
        var duration = document.getElementById('chargeDuration').value;
        var price = duration * 1000;

        IMP.request_pay({
            pg: "kakaopay",
            pay_method: "card",
            merchant_uid: "CHG" + new Date().getTime(),
            name: "ì‹œê°„ ì¶©ì „ " + duration + "ì‹œê°„",
            amount: price,
            buyer_email: "test@test.com",
            buyer_name: "ì‚¬ìš©ì"
        }, function (rsp) {
            if (rsp.success) {
                alert("ì¶©ì „ ì„±ê³µ! (ì´ìš© ì¤‘ì¸ ì¢Œì„ì´ ìˆë‹¤ë©´ ìë™ ì—°ì¥ë©ë‹ˆë‹¤)");
                document.getElementById('formChargeDuration').value = duration;
                document.getElementById('chargeForm').submit();
            } else {
                alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
            }
        });
    }

    // ì˜ˆì•½ ëª¨ë‹¬ì—ì„œ ê²°ì œ ìš”ì²­
    function requestPayAndReserve() {
        var seatId = document.getElementById('modalSeatId').value;
        var duration = document.getElementById('durationSelect').value;
        var price = duration * 1000;

        IMP.request_pay({
            pg: "kakaopay",
            pay_method: "card",
            merchant_uid: "RES" + new Date().getTime(),
            name: duration + "ì‹œê°„ ì´ìš©ê¶Œ",
            amount: price,
            buyer_email: "test@test.com",
            buyer_name: "ì‚¬ìš©ì"
        }, function (rsp) {
            if (rsp.success) {
                alert("ê²°ì œ ì„±ê³µ! ì˜ˆì•½ì„ í™•ì •í•©ë‹ˆë‹¤.");
                var form = document.getElementById('reserveForm');
                form.action = '/book/' + seatId;
                form.submit();
            } else {
                alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
            }
        });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
</script>

</body>
</html>